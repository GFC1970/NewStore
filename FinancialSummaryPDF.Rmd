---
title: "Financial Summary"
author: "Graham Cox"
date: "`r format(Sys.time(), '%d %b %Y')`"
output: 
  pdf_document:
    latex_engine: xelatex
    toc: TRUE
    toc_depth: 2
mainfont: Roboto Condensed
---

\fontsize{12}{22}
\selectfont

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, dev = "cairo_pdf", fig.height = 3)
```

```{r prepData, echo=FALSE, include=FALSE}

library(tidytext)
library(tidyverse)
library(tidyquant)
library(lubridate)
library(extrafont)
library(ggridges)
library(knitr)
library(kableExtra)
library(ggsci)

# Load Dimensions Data ----
customers_tbl <- read_csv("dimensions/customers.csv")
products_tbl <- read_csv("dimensions/products.csv")

# Load fact data ----
# Data directory containing fact data files
data_dir <- "data"
# Load data from directory and use map to load all files into a data frame
# join to dimension tibbles
# transform columns by splitting and mutating
data_tbl <- data_dir %>%
  # Create a list of files from the data directory
  fs::dir_ls() %>%
  # Load files from list of files into data frame using read_csv and
  # map_dfr to create one dataframe tibble
  map_dfr(read_csv) %>%
  # Join fact tibble to dimension tibbles using inner joins
  # products table contains different naming for main lookup column
  # use by within inner_join to identify connecting lookup tables
  inner_join(products_tbl, by = c("product_index" = "product_id")) %>%
  # Join fact table to customers tibble
  inner_join(customers_tbl) %>%
  # Separate product column into new columns based on - delimiter
  separate(col = product,
           into = c("product_name", "product_size", "product_colour", "product_category"),
           sep = "-") %>%
  # Mutate customer type into Retail ad Wholesale
  # 0 = Retail
  # 1 = Wholesale
  mutate(customer_type = case_when(
    customer_type == 0 ~ "Retail",
    TRUE ~ "Wholesale"
  )) %>%
  # Amend column types to factors and dates
  mutate(
    order_date = order_date %>% dmy(),
    product_name = product_name %>% as_factor(),
    product_size = product_size %>% as_factor(),
    product_colour = product_colour %>% as_factor(),
    product_category = product_category %>% as_factor(),
    customer_name = customer_name %>% as_factor(),
    customer_city = customer_city %>% as_factor(),
    customer_type = customer_type %>% as_factor()
  ) %>%
  # Add calculated column for total cost and total revenue
  mutate(
    total_cogs = order_units * product_cost,
    total_revenue = order_units * product_price
  ) %>%
  # drop columns no longer required
  # product index, customer index
  select(-contains(c("index", "id")), -c("product_cost", "product_price"))

```

\newpage

# Summary

Total units delivered for period `r format(min(data_tbl$order_date), "%d %B %Y")` to `r format(max(data_tbl$order_date), "%d %B %Y")` is `r scales::comma(sum(data_tbl$order_units))` with a total revenue of `r scales::dollar(sum(data_tbl$total_revenue), accuracy = .01, scale = 1e-4, prefix = "\u00A3", suffix = "m")` from a total number of orders `r scales::comma(nrow(data_tbl))`, costing a total of `r scales::dollar(sum(data_tbl$total_cogs), accuracy = .01, scale = 1e-4, prefix = "\u00A3", suffix = "m")`.

# Revenue Summary

## Total Revenue by Year

```{r, echo=FALSE}

data_tbl %>% 
  mutate(yr = order_date %>% year() %>% as_factor()) %>% 
  group_by(yr) %>% 
  summarise(revenue = sum(total_revenue), .groups = "drop") %>% 
  ggplot(aes(yr, revenue)) +
  geom_col(fill = "yellowgreen") +
  geom_text(aes(label = scales::dollar(revenue, accuracy = 1, prefix = "\u00A3")), vjust = -.9, family = "Roboto Condensed", size = 4) +
  labs(
    subtitle = "All categories and products.",
    x = NULL,
    y = NULL
  ) +
  scale_y_continuous(expand = expansion(mult = c(0, .2))) +
  theme_minimal(base_family = "Roboto Condensed") +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_text(face = "bold", size = 12),
    panel.grid = element_blank(),
    panel.grid.major.y = element_line(linetype = "dashed", colour = "grey75")
  )

```

\newpage

## Total Revenue by Year and Month

Revenue amounts shown in Â£ GBP Sterling

```{r, echo=FALSE, warning=FALSE, include=TRUE, message=FALSE, error=FALSE}

data_tbl %>% 
  select(order_date, product_category, total_revenue) %>% 
  mutate(yr = order_date %>% year() %>% as_factor(),
         mth = floor_date(order_date, unit = "month")) %>% 
  group_by(yr, mth) %>% 
  mutate(mth = mth %>% format("%b")) %>% 
  summarise(revenue = sum(total_revenue)) %>% 
  mutate(mth = mth %>% factor(levels = c("Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"))) %>% 
  spread(key = yr, value = revenue) %>% 
  rename(Month = mth) %>% 
  mutate_if(is.numeric, scales::dollar_format(accuracy = 1, prefix = "")) %>% 
  kable(align = "lrrrrrr") %>%
  kable_styling(bootstrap_options = "striped", full_width = TRUE, font_size = 12) %>% 
  row_spec(0, bold = TRUE)
  

```

```{r echo=FALSE, fig.height=5.5, out.width="100%"}
data_tbl %>% 
  select(order_date, product_category, total_revenue) %>% 
  mutate(yr = order_date %>% year() %>% as_factor(),
         mth = floor_date(order_date, unit = "month")) %>% 
  group_by(yr, mth) %>% 
  summarise(revenue = sum(total_revenue), .groups = "drop") %>%
  ggplot(aes(mth, revenue, fill = yr)) +
  geom_col(show.legend = FALSE) +
  facet_wrap(~ yr, scales = "free_x", ncol = 2) +
  scale_fill_futurama() +
  labs(
    x = NULL,
    y = NULL
  ) +
  scale_x_date(date_breaks = "1 month", date_labels = "%b") +
  scale_y_continuous(expand = expansion(mult = c(0, .2)), labels = scales::comma_format(
      scale = 1e-3,
      prefix = "\u00A3",
      suffix = "k"
    )) +
  theme_minimal(base_family = "Roboto Condensed") +
  theme(
    axis.text.x = element_text(size = 10),
    panel.grid = element_blank(),
    panel.grid.major.y = element_line(linetype = "dashed", colour = "grey75"),
    strip.text = element_text(hjust = 0, face = "bold", size = 12),
    strip.background = element_rect(fill = "grey90", colour = "grey85")
  )
```

\newpage

## Total Revenue by Product Category

```{r echo=FALSE, warning=FALSE, include=TRUE, message=FALSE, error=FALSE, results="hide", fig.height=4, out.width="100%"}

data_tbl %>% 
  select(product_category, order_date, total_revenue) %>% 
  mutate(yr = order_date %>% year() %>% as_factor()) %>% 
  group_by(product_category, yr) %>% 
  summarise(revenue = sum(total_revenue)) %>% 
  group_split() %>% 
  map(
    .f = function(df) {
      
      ggplot(df, aes(yr, revenue)) +
        geom_col(show.legend = FALSE, fill = "#018EA0") +
        geom_text(aes(label = scales::dollar(revenue, accuracy = 1, prefix = "\u00A3")), vjust = -.9, family = "Roboto Condensed", size = 4) +
  labs(
    subtitle = df$product_category,
    x = NULL,
    y = NULL
  ) +
  scale_y_continuous(expand = expansion(mult = c(0, .2))) +
  theme_minimal(base_family = "Roboto Condensed") +
  theme(
    axis.text.y = element_blank(),
    axis.text.x = element_text(face = "bold", size = 12),
    panel.grid = element_blank(),
    panel.grid.major.y = element_line(linetype = "dashed", colour = "grey75"),
    plot.subtitle = element_text(size = 16, face = "bold", colour = "#018EA0")
  )
    
      }
  )
```

